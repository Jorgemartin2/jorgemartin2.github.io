name: Update Challenge Date

on:
  push:
    paths:
      - "posts/**/*.md"     # Detecta qualquer post modificado

jobs:
  update-date:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Identify modified markdown file
        id: changed
        run: |
          FILE=$(git diff --name-only HEAD~1 HEAD | grep ".md$")
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Extract ID from filename
        id: extract
        run: |
          FILE=${{ steps.changed.outputs.file }}
          BASENAME=$(basename "$FILE" .md)
          echo "id=$BASENAME" >> $GITHUB_OUTPUT

      - name: Update JSON date in both files
        run: |
          ID=${{ steps.extract.outputs.id }}

          # Formato Nov 20, 2025
          DATE=$(date +"%b %-d, %Y")

          echo "Atualizando ID: $ID com data: $DATE"

          ### 1️⃣ Atualizar posts.json
          if [ -f posts.json ]; then
            jq --arg id "$ID" --arg date "$DATE" '
              map(if .id == $id then .date = $date else . end)
            ' posts.json > posts.tmp && mv posts.tmp posts.json
          fi

          ### 2️⃣ Atualizar challenges/challenges.json
          if [ -f challenges/challenges.json ]; then
            jq --arg id "$ID" --arg date "$DATE" '
              map(if .id == $id then .date = $date else . end)
            ' challenges/challenges.json > challenges.tmp && mv challenges.tmp challenges/challenges.json
          fi

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add posts.json || true
          git add challenges/challenges.json || true

          git commit -m "Auto-update date for ${{ steps.extract.outputs.id }}" || true
          git push || true